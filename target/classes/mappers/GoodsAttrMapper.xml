<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gec.dao.GoodsAttrMapper">

    <!--
    if(att.attr_type=1, '基本属性','销售属性') attr_type_name
    -->
    <select id="getGoodsAttrList" resultMap="attrBOMap">
        SELECT att.*, RA.attr_group_id, g.group_name
            FROM tbl_goods_attr att
            LEFT JOIN tbl_group_attr_relation RA
                ON RA.attr_id=att.id
            LEFT JOIN tbl_goods_attr_group g
                ON ra.attr_group_id=g.id
            WHERE 1=1
            <if test="param.categoryId != null">
                AND att.category_id=#{param.categoryId}
            </if>
            <if test="param.attrType != null">
                AND att.attr_type=#{param.attrType}
            </if>
            <if test="param.id != null">
                AND att.id=#{param.id}
            </if>
            <if test="param.attrName != null and param.attrName != ''">
                AND att.attr_name like concat('%', #{param.attrName}, '%')
            </if>
    </select>

    <resultMap id="attrBOMap" type="com.gec.domain.bo.GoodsAttrBO">
        <id column="id" property="id"/>
        <result column="attr_name" property="attrName"/>
        <result column="category_id" property="categoryId"/>
        <result column="attr_type" property="attrType"/>
        <result column="search_enable" property="searchEnable"/>
        <result column="enable" property="enable"/>
        <result column="value_type" property="valueType"/>
        <result column="attr_value" property="attrValue"/>
        <result column="create_date" property="createDate"/>
        <result column="attr_group_id" property="attrGroupId"/>
        <result column="group_name" property="groupName"/>
    </resultMap>

    <select id="getAttrValByAttrId" resultType="com.gec.domain.entity.GoodsAttrValue">
        select * from tbl_goods_attr_value val
        where
        <choose>
            <when test="ids!=null and ids.size()>0">
                val.attr_id in
                (
                <foreach collection="ids" separator="," item="tId">
                    #{ tId }
                </foreach>
                )
            </when>
            <otherwise>
                1 > 1
            </otherwise>
        </choose>
    </select>

    <insert id="addGoodsAttrVal">
        insert into
            tbl_goods_attr_value
            (id, spu_id, attr_id, value_type, attr_value)
        values(null,null,#{id},#{valueType},#{attrValue});
    </insert>

    <!--
    int setRelation(
        Integer id, Integer attrGroupId
    );
    -->
    <insert id="setRelation">
        insert into
            tbl_group_attr_relation
            (attr_group_id, attr_id)
        values(#{attrGroupId}, #{attrId});
    </insert>

    <!--
    void removeAttrVal(Integer id);
    -->
    <delete id="removeAttrVal">
        delete from tbl_goods_attr_value where attr_id = #{id};
    </delete>

</mapper>
